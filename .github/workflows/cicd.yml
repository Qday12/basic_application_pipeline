# secrets: AWS_ACCOUNT_ID, AWS_ROLE_ARN_ECR_PUSH

name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.$AWS_REGION.amazonaws.com
  IMAGE_NAME: hello-flask-app
  HELM_CHART_NAME: hello-chart
  AWS_REGION: eu-central-1
  CLUSTER_NAME: hello-eks-cluster

jobs:

  run_test:
    name: run_test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        working-directory: ./app
        run: |
          pip install -r requirements.txt

      - name: Run tests
        working-directory: ./app
        run: |
          pytest test_app.py -v

###############################################################
  build_and_push_docker_image:
    name: build_and_push_docker_image
    runs-on: ubuntu-latest
    needs: run_test

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_ECR_PUSH }}
          aws-region: $AWS_REGION

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        working-directory: ./app
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG $ECR_REGISTRY/$IMAGE_NAME:latest
          docker push $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG
          docker push $ECR_REGISTRY/$IMAGE_NAME:latest

###############################################################
  build_and_push_helm_chart:
    name: build_and_push_helm_chart
    runs-on: ubuntu-latest
    needs: build_and_push_docker_image

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_ECR_PUSH }}
          aws-region: $AWS_REGION

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Package and push Helm chart
        env:
          CHART_VERSION: 0.1.${{ github.run_number }}
        run: |
          helm package k8s/$HELM_CHART_NAME --version $CHART_VERSION
          helm push $HELM_CHART_NAME-$CHART_VERSION.tgz oci://$ECR_REGISTRY

###############################################################
  deploy_to_kubernetes_cluster:
    name: deploy_to_kubernetes_cluster
    runs-on: ubuntu-latest
    needs: build_and_push_helm_chart

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_ECR_PUSH }}
          aws-region: $AWS_REGION

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --name $CLUSTER_NAME --region $AWS_REGION

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy Helm chart
        env:
          IMAGE_TAG: ${{ github.sha }}
          CHART_VERSION: 0.1.${{ github.run_number }}
        run: |
          helm upgrade --install hello-app oci://$ECR_REGISTRY/$HELM_CHART_NAME --version $CHART_VERSION \
            --set image.repository=$ECR_REGISTRY/$IMAGE_NAME \
            --set image.tag=$IMAGE_TAG \
            --wait